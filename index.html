<html>

<head>
    <title>Caliper JS Sensor Test Page</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
    <script src="dist/caliperSensor-1.1.0.js"></script>
</head>

<body>
    <h1>Caliper JS Sensor Test</h1>

    <script type="text/javascript">
    $(document).ready(function() {

        // Initialize sensor with options
        var sensor = Caliper.Sensor;

        sensor.initialize('https://example.edu/sensor/001', {
            host: '127.0.0.1',
            port: '8070',
            path: '/v1p1/custom/eventdata'
        });

        const BASE_COURSE_IRI = "https://example.edu/politicalScience/2015/american-revolution-101";
        const BASE_EPUB_IRI = "https://example.com/viewer/book/34843";

        // The Actor for the Caliper Event
        var actorId = "https://example.edu/user/554433";
        var actor = Caliper.Entities.EntityFactory().create(Caliper.Entities.Person, actorId, {
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString()
        });

        // Federated Session
        var sessionId = "https://example.edu/lms/federatedSession/123456789";
        var session = Caliper.Entities.EntityFactory().create(Caliper.Entities.Session, sessionId, {
            actor: actor,
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            startedAtTime: new Date("2015-09-15T10:15:00Z").toISOString()
        });

        // The Action for the Caliper Event
        var action = Caliper.Actions.NavigationActions.NAVIGATED_TO;

        // The Object being interacted with by the Actor
        var obj = Caliper.Entities.EntityFactory().create(Caliper.Entities.EPubVolume, BASE_EPUB_IRI.concat("#epubcfi(/4/3)"), {
            name: "The Glorious Cause: The American Revolution, 1763-1789 (Oxford History of the United States)",
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString(),
            version: "2nd ed."
        });

        // The target object (frame) within the Event Object
        var target = Caliper.Entities.EntityFactory().create(Caliper.Entities.Frame, BASE_EPUB_IRI.concat("#epubcfi(/4/3/1)"), {
            name: "Key Figures: George Washington",
            isPartOf: obj,
            index: 1,
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString(),
            version: "2nd ed."
        });

        // Specific to the Navigation Event - the location where the user navigated from
        var referrer = Caliper.Entities.EntityFactory().create(Caliper.Entities.WebPage, BASE_COURSE_IRI.concat("/index.html"), {
            name: "American Revolution 101 Landing Page",
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString(),
            version: "1.0"
        });

        // The edApp
        var edAppId = "https://example.com/viewer";
        var edApp = Caliper.Entities.EntityFactory().create(Caliper.Entities.SoftwareApplication, edAppId, {
            name: "ePub",
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString(),
            version: "1.2.3"
        });

        // LIS Course Offering
        var course = Caliper.Entities.EntityFactory().create(Caliper.Entities.CourseOffering, BASE_COURSE_IRI, {
            name: "Political Science 101: The American Revolution",
            courseNumber: "POL101",
            academicSession: "Fall-2015",
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString()
        });

        // LIS Course Section
        var sectionId = BASE_COURSE_IRI.concat("/section/001");
        var section = Caliper.Entities.EntityFactory().create(Caliper.Entities.CourseSection, sectionId, {
            name: "American Revolution 101",
            courseNumber: "POL101",
            academicSession: "Fall-2015",
            subOrganizationOf: course,
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString(),
            dateModified: new Date("2015-09-02T11:30:00Z").toISOString()
        });

        // LIS Group
        var groupId = sectionId.concat("/group/001");
        var group = Caliper.Entities.EntityFactory().create(Caliper.Entities.Group, groupId, {
            name: "Discussion Group 001",
            subOrganizationOf: section,
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString()
        });

        // The Actor's Membership
        var membershipId = BASE_COURSE_IRI.concat("/roster/554433");
        var membership = Caliper.Entities.EntityFactory().create(Caliper.Entities.Membership, membershipId, {
            name: "American Revolution 101",
            description: "Roster entry",
            member: actor['@id'],
            organization: section['@id'],
            roles: [Caliper.Entities.Role.LEARNER],
            status: Caliper.Entities.Status.ACTIVE,
            dateCreated: new Date("2015-08-01T06:00:00Z").toISOString()
        });

        // Assert that key attributes are the same
        var event = Caliper.Events.EventFactory().create(Caliper.Events.NavigationEvent, {
            actor: actor,
            action: action,
            object: obj,
            eventTime: new Date("2015-09-15T10:15:00Z").toISOString(),
            target: target,
            referrer: referrer,
            edApp: edApp,
            group: group,
            membership: membership,
            federatedSession: session['@id']
        });

        console.log('created navigation event %O', event);

        var currentTime = new Date().getTime().toISOString;

        // Send the Event
        var envelope = new Caliper.Request.Envelope();
        envelope.setSensor("https://example.edu/sensor/001");
        envelope.setSendTime(currentTime);
        envelope.setData(event);

        //envelope['_id'] = 'caliper-js' + currentTimeMillis;
        //envelope.d = event;
        console.log('created event envelope %O', envelope);

        sensor.send(envelope);

    });
    </script>

</body>

</html>
