<html>

<head>
    <title>Caliper JS Sensor Test Page</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
    <script src="dist/caliperSensor-1.1.0.js"></script>
</head>

<body>
    <h1>Caliper JS Sensor Test</h1>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.1/moment.min.js" type="text/javascript"></script>
    <script type="text/javascript">
    $(document).ready(function() {

      // Initialize Sensor and register Client (delegation chain)
      var sensor = Caliper.Sensor;
      sensor.initialize("https://example.com/sensor/1");
      var config = Caliper.Config.Config;
      var options = Caliper.Clients.HttpOptions;
      options.uri = "http://127.0.0.1:8070/test/endpoint";
      var client = Caliper.Clients.HttpClient;
      client.initialize(sensor.id.concat("/clients/1"), options);
      sensor.registerClient(client);

      const BASE_COURSE_IRI = "https://example.edu/politicalScience/2017/american-revolution-101";
      const BASE_EPUB_IRI = "https://example.com/viewer/book/34843";

      var eventId = "urn:uuid:d4618c23-d612-4709-8d9a-478d87808067";

      // The Actor for the Caliper Event
      var actor = Caliper.Entities.EntityFactory().create(Caliper.Entities.Person, {
        id: "https://example.edu/user/554433",
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z")
      });

      // The Action for the Caliper Event
      var action = Caliper.Actions.navigatedTo.term;

      // The Object being interacted with by the Actor
      var obj = Caliper.Entities.EntityFactory().create(Caliper.Entities.Document, {
        id: BASE_EPUB_IRI.concat("#epubcfi(/4/3)"),
        name: "The Glorious Cause: The American Revolution, 1763-1789 (Oxford History of the United States)",
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z"),
        version: "2nd ed."
      });

      // The target object (frame) within the Event Object
      var target = Caliper.Entities.EntityFactory().create(Caliper.Entities.Frame, {
        id: BASE_EPUB_IRI.concat("#epubcfi(/4/3/1)"),
        name: "Key Figures: George Washington",
        isPartOf: obj,
        index: 1,
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z"),
        version: "2nd ed."
      });

      // Specific to the Navigation Event - the location where the user navigated from
      var referrer = Caliper.Entities.EntityFactory().create(Caliper.Entities.WebPage, {
        id: BASE_COURSE_IRI.concat("/index.html"),
        name: "American Revolution 101 Landing Page",
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z"),
        version: "1.0"
      });

      // The edApp
      var edApp = Caliper.Entities.EntityFactory().create(Caliper.Entities.SoftwareApplication, {
        id: "https://example.com/viewer",
        name: "ePub",
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z"),
        version: "1.2.3"
      });

      // LIS Course Offering
      var course = Caliper.Entities.EntityFactory().create(Caliper.Entities.CourseOffering, {
        id: BASE_COURSE_IRI,
        name: "Political Science 101: The American Revolution",
        courseNumber: "POL101",
        academicSession: "Fall-2017",
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z")
      });

      // LIS Course Section (Event.group)
      var section = Caliper.Entities.EntityFactory().create(Caliper.Entities.CourseSection, {
        id: BASE_COURSE_IRI.concat("/section/001"),
        name: "American Revolution 101",
        courseNumber: "POL101",
        academicSession: "Fall-2017",
        subOrganizationOf: course,
        dateCreated: moment("2017-08-01T06:00:00Z"),
        dateModified: moment("2017-09-02T11:30:00Z")
      });

      // The Actor's Membership
      var membership = Caliper.Entities.EntityFactory().create(Caliper.Entities.Membership, {
        id: BASE_COURSE_IRI.concat("/roster/554433"),
        name: "American Revolution 101",
        description: "Roster entry",
        member: actor.id,
        organization: section.id,
        roles: [ Caliper.Entities.Role.learner.term ],
        status: Caliper.Entities.Status.active.term,
        dateCreated: moment("2017-08-01T06:00:00Z")
      });

      // Session
      var session = Caliper.Entities.EntityFactory().create(Caliper.Entities.Session, {
        id: "https://example.edu/lms/federatedSession/123456789",
        dateCreated: moment("2017-08-01T06:00:00Z"),
        startedAtTime: moment("2017-09-15T10:15:00Z")
      });

      // Assert that key attributes are the same
      var event = Caliper.Events.EventFactory().create(Caliper.Events.NavigationEvent, {
        id: eventId,
        actor: actor,
        action: action,
        object: obj,
        eventTime: moment("2017-09-15T10:15:00Z"),
        target: target,
        referrer: referrer,
        edApp: edApp,
        group: section,
        membership: membership,
        session: session
      });

      console.log('INFO: created navigation event %O', event);

      // Create data payload
      var data = [];
      data.push(event);

      // Create envelope with data payload.
      var envelope = sensor.createEnvelope({
        sensor: client.id,
        sendTime: moment.utc(),
        dataVersion: config.dataVersion,
        data: data
      });

      console.log('INFO: created envelope %O', envelope);

      // Pass envelope to client to transmit.
      sensor.sendToClient(client, envelope);

      console.log('INFO: sent envelope containing navigation event');
    });
    </script>
</body>
</html>